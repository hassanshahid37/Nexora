<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Advanced Editor</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
/* ===== GLOBAL ===== */
body {
  margin: 0;
  font-family: "Poppins", sans-serif;
  background: #0b0e17;
  color: #ffffff;
  overflow: hidden;
  user-select: none;
}
* { box-sizing: border-box; }

/* ===== LAYOUT GRID ===== */
.editor-layout {
  display: grid;
  grid-template-columns: 80px 1fr 300px;
  height: 100vh;
}

/* ===== LEFT TOOLBAR ===== */
.left-tools {
  background: rgba(255, 255, 255, 0.06);
  backdrop-filter: blur(12px);
  padding-top: 18px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 18px;
  border-right: 1px solid rgba(255,255,255,0.12);
}
.tool-btn {
  width: 48px;
  height: 48px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 12px;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 22px;
  cursor: pointer;
  transition: 0.2s;
}
.tool-btn:hover { background: rgba(255,255,255,0.2); transform: scale(1.05); }

/* ===== TOP BAR ===== */
.top-bar {
  position: fixed;
  top: 0;
  left: 80px;
  right: 300px;
  height: 60px;
  display: flex;
  align-items: center;
  padding: 0 20px;
  gap: 16px;
  background: rgba(255,255,255,0.06);
  backdrop-filter: blur(12px);
  border-bottom: 1px solid rgba(255,255,255,0.12);
  z-index: 10;
}
.top-btn {
  padding: 8px 16px;
  background: rgba(255,255,255,0.15);
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  transition: 0.2s;
}
.top-btn:hover { background: rgba(255,255,255,0.25); }

/* ===== CANVAS AREA ===== */
.canvas-area {
  position: relative;
  margin-top: 60px;
  display: flex;
  justify-content: center;
  align-items: center;
  overflow: auto;
}
#designCanvas {
  background: white;
  border-radius: 8px;
  box-shadow: 0 0 30px rgba(0,0,0,0.25);
  position: relative;
}

/* ===== EDITABLE ELEMENTS ===== */
.element {
  position: absolute;
  cursor: move;
  user-select: none;
  border: 1px dashed transparent;
}
.element.active { border: 1px dashed #4a90e2; }

/* Resize Handles */
.resize-handle {
  width: 12px;
  height: 12px;
  background: #4a90e2;
  border-radius: 50%;
  position: absolute;
  cursor: nwse-resize;
}
.resize-handle.br { bottom: -6px; right: -6px; }
.resize-handle.bl { bottom: -6px; left: -6px; }
.resize-handle.tr { top: -6px; right: -6px; }
.resize-handle.tl { top: -6px; left: -6px; }

/* Rotation Handle */
.rotate-handle {
  width: 14px;
  height: 14px;
  background: #4a90e2;
  border-radius: 50%;
  position: absolute;
  top: -28px;
  left: 50%;
  transform: translateX(-50%);
  cursor: grab;
}

/* ===== RIGHT PANEL ===== */
.right-panel {
  background: rgba(255,255,255,0.06);
  backdrop-filter: blur(12px);
  border-left: 1px solid rgba(255,255,255,0.12);
  padding: 20px;
  overflow-y: auto;
}
.section-title {
  font-size: 13px;
  opacity: 0.9;
  margin-bottom: 6px;
  font-weight: 600;
}
.panel-block { margin-bottom: 20px; }

input[type='color'],
input[type='number'],
input[type='range'],
select {
  width: 100%;
  padding: 6px;
  border-radius: 6px;
  background: rgba(255,255,255,0.15);
  border: 1px solid rgba(255,255,255,0.25);
  color: white;
  margin-bottom: 10px;
}

/* Shapes */
.shape-rect {
  width: 150px;
  height: 100px;
  background: #4a90e2;
}
.shape-circle {
  width: 120px;
  height: 120px;
  background: #e24aaa;
  border-radius: 50%;
}
</style>
</head>

<body>

<div class="editor-layout">

  <!-- LEFT TOOLBAR -->
  <div class="left-tools">
    <div class="tool-btn" id="toolText">T</div>
    <div class="tool-btn" id="toolShape">‚ñ¢</div>
    <div class="tool-btn" id="toolCircle">‚óØ</div>
    <div class="tool-btn" id="toolImage">üñºÔ∏è</div>
  </div>

  <!-- TOP BAR -->
  <div class="top-bar">
    <div class="top-btn" id="undoBtn">‚Ü∂ Undo</div>
    <div class="top-btn" id="redoBtn">‚Ü∑ Redo</div>

    <select id="canvasSize" class="top-btn">
      <option value="1080x1080">Instagram Square</option>
      <option value="1080x1920">Story / TikTok</option>
      <option value="1280x720">YouTube Thumbnail</option>
      <option value="1200x630">Facebook Post</option>
      <option value="2480x3508">A4 Flyer</option>
    </select>

    <div class="top-btn" id="saveProject">üíæ Save</div>
    <div class="top-btn" id="exportPNG">‚¨á PNG</div>
  </div>

  <!-- CANVAS AREA -->
  <div class="canvas-area">
    <div id="designCanvas"></div>
  </div>

  <!-- RIGHT PANEL -->
  <div class="right-panel">

    <div class="panel-block">
      <div class="section-title">Text</div>
      <select id="textFont">
        <option>Poppins</option>
        <option>Inter</option>
        <option>Montserrat</option>
        <option>Lato</option>
      </select>

      <label>Size</label>
      <input type="number" id="textSize" value="32">

      <label>Color</label>
      <input type="color" id="textColor">
    </div>

    <div class="panel-block">
      <div class="section-title">Layer</div>
      <div class="top-btn" id="bringFront">Bring Front</div>
      <div class="top-btn" id="sendBack">Send Back</div>
    </div>

    <div class="panel-block">
      <div class="section-title">Rotation</div>
      <input type="range" id="rotateControl" min="-180" max="180" value="0">
    </div>

    <div class="panel-block">
      <div class="section-title">Opacity</div>
      <input type="range" id="opacityControl" min="0" max="1" step="0.05" value="1">
    </div>

  </div>

</div>

<script>
let canvas = document.getElementById("designCanvas");
let activeElement = null;
let offsetX, offsetY;
let isResizing = false;
let isRotating = false;
let originalMouseX, originalMouseY;
let originalWidth, originalHeight;
let originalRotation = 0;

let undoStack = [];
let redoStack = [];

function saveState() {
  undoStack.push(canvas.innerHTML);
  redoStack = [];
}
function undo() {
  if (undoStack.length > 0) {
    redoStack.push(canvas.innerHTML);
    canvas.innerHTML = undoStack.pop();
    attachElementEvents();
  }
}
function redo() {
  if (redoStack.length > 0) {
    undoStack.push(canvas.innerHTML);
    canvas.innerHTML = redoStack.pop();
    attachElementEvents();
  }
}

function createResizeHandles(el) {
  ["tl", "tr", "bl", "br"].forEach(pos => {
    let h = document.createElement("div");
    h.classList.add("resize-handle", pos);
    el.appendChild(h);
  });
  let rot = document.createElement("div");
  rot.classList.add("rotate-handle");
  el.appendChild(rot);
}

function addElement(el) {
  saveState();
  canvas.appendChild(el);
  attachElementEvents();
}

function attachElementEvents() {
  const elements = document.querySelectorAll(".element");

  elements.forEach(el => {
    el.onmousedown = selectElement;

    el.querySelectorAll(".resize-handle").forEach(h => {
      h.onmousedown = startResize;
    });

    let rot = el.querySelector(".rotate-handle");
    if (rot) rot.onmousedown = startRotate;
  });
}

function selectElement(e) {
  if (e.target.classList.contains("resize-handle") ||
      e.target.classList.contains("rotate-handle")) return;

  if (activeElement) activeElement.classList.remove("active");

  activeElement = e.currentTarget;
  activeElement.classList.add("active");

  const rect = activeElement.getBoundingClientRect();
  offsetX = e.clientX - rect.left;
  offsetY = e.clientY - rect.top;

  saveState();

  document.onmousemove = dragElement;
  document.onmouseup = stopAction;
}

function dragElement(e) {
  if (!activeElement || isResizing || isRotating) return;

  let x = e.clientX - offsetX - canvas.getBoundingClientRect().left;
  let y = e.clientY - offsetY - canvas.getBoundingClientRect().top;

  activeElement.style.left = x + "px";
  activeElement.style.top = y + "px";
}

function stopAction() {
  document.onmousemove = null;
  document.onmouseup = null;
  isResizing = false;
  isRotating = false;
}

function startResize(e) {
  e.stopPropagation();
  isResizing = true;

  activeElement = this.parentElement;
  activeElement.classList.add("active");

  originalMouseX = e.clientX;
  originalMouseY = e.clientY;

  originalWidth = activeElement.offsetWidth;
  originalHeight = activeElement.offsetHeight;

  saveState();

  document.onmousemove = resizeElement;
  document.onmouseup = stopAction;
}

function resizeElement(e) {
  if (!isResizing) return;

  let dx = e.clientX - originalMouseX;
  let dy = e.clientY - originalMouseY;

  activeElement.style.width = originalWidth + dx + "px";
  activeElement.style.height = originalHeight + dy + "px";
}

function startRotate(e) {
  e.stopPropagation();
  isRotating = true;

  activeElement = this.parentElement;
  activeElement.classList.add("active");

  const style = window.getComputedStyle(activeElement);
  const transform = style.transform;

  if (transform !== "none") {
    const values = transform.split("(")[1].split(")")[0].split(",");
    const a = values[0];
    const b = values[1];
    originalRotation = Math.round(Math.atan2(b, a) * (180 / Math.PI));
  }

  saveState();

  document.onmousemove = rotateElement;
  document.onmouseup = stopAction;
}

function rotateElement(e) {
  if (!isRotating) return;

  const rect = activeElement.getBoundingClientRect();
  const cx = rect.left + rect.width / 2;
  const cy = rect.top + rect.height / 2;

  const angle = Math.atan2(e.clientY - cy, e.clientX - cx);
  const deg = angle * (180 / Math.PI);

  activeElement.style.transform = `rotate(${deg}deg)`;
  document.getElementById("rotateControl").value = deg;
}

document.getElementById("toolText").onclick = () => {
  let text = document.createElement("div");
  text.classList.add("element");
  text.style.left = "100px";
  text.style.top = "100px";
  text.style.fontSize = "32px";
  text.style.color = "#000";
  text.style.fontWeight = "600";
  text.textContent = "Double-click to edit";

  createResizeHandles(text);
  addElement(text);

  text.ondblclick = () => {
    let newText = prompt("Edit text:", text.textContent);
    if (newText !== null) text.textContent = newText;
  };
};

document.getElementById("toolShape").onclick = () => {
  let rect = document.createElement("div");
  rect.classList.add("element", "shape-rect");
  rect.style.left = "120px";
  rect.style.top = "120px";
  createResizeHandles(rect);
  addElement(rect);
};

document.getElementById("toolCircle").onclick = () => {
  let circle = document.createElement("div");
  circle.classList.add("element", "shape-circle");
  circle.style.left = "150px";
  circle.style.top = "150px";
  createResizeHandles(circle);
  addElement(circle);
};

document.getElementById("toolImage").onclick = () => {
  let input = document.createElement("input");
  input.type = "file";
  input.accept = "image/*";
  input.click();

  input.onchange = () => {
    let file = input.files[0];
    let reader = new FileReader();

    reader.onload = function (e) {
      let img = document.createElement("img");
      img.src = e.target.result;
      img.classList.add("element");
      img.style.width = "200px";
      img.style.left = "150px";
      img.style.top = "150px";

      createResizeHandles(img);
      addElement(img);
    };

    reader.readAsDataURL(file);
  };
};

document.getElementById("textFont").onchange = (e) => {
  if (activeElement) activeElement.style.fontFamily = e.target.value;
};
document.getElementById("textSize").oninput = (e) => {
  if (activeElement) activeElement.style.fontSize = e.target.value + "px";
};
document.getElementById("textColor").oninput = (e) => {
  if (activeElement) activeElement.style.color = e.target.value;
};

document.getElementById("opacityControl").oninput = (e) => {
  if (activeElement) activeElement.style.opacity = e.target.value;
};

document.getElementById("rotateControl").oninput = (e) => {
  if (activeElement) activeElement.style.transform = `rotate(${e.target.value}deg)`;
};

document.getElementById("bringFront").onclick = () => {
  if (activeElement) activeElement.style.zIndex = 999;
};
document.getElementById("sendBack").onclick = () => {
  if (activeElement) activeElement.style.zIndex = 1;
};

document.getElementById("canvasSize").onchange = (e) => {
  let [w, h] = e.target.value.split("x");
  canvas.style.width = w + "px";
  canvas.style.height = h + "px";
};

canvas.style.width = "1080px";
canvas.style.height = "1080px";

document.getElementById("undoBtn").onclick = undo;
document.getElementById("redoBtn").onclick = redo;

</script>

<script>
// html2canvas loader
let script = document.createElement("script");
script.src = "https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js";
document.body.appendChild(script);

document.getElementById("exportPNG").onclick = () => {
  html2canvas(canvas, {
    backgroundColor: null,
    scale: 2
  }).then(canvasImage => {
    const link = document.createElement("a");
    link.download = "design.png";
    link.href = canvasImage.toDataURL("image/png");
    link.click();
  });
};

document.getElementById("saveProject").onclick = () => {
  const project = {
    html: canvas.innerHTML,
    width: canvas.style.width,
    height: canvas.style.height
  };
  localStorage.setItem("savedDesign", JSON.stringify(project));
  alert("Project Saved!");
};

window.onload = () => {
  const params = new URLSearchParams(window.location.search);
  const imgURL = params.get("img");

  if (imgURL) {
    // opened from template ‚Üí start fresh with that image
    canvas.innerHTML = "";
    canvas.style.width = "1080px";
    canvas.style.height = "1080px";

    let img = document.createElement("img");
    img.src = imgURL;
    img.classList.add("element");
    img.style.width = "500px";
    img.style.left = "100px";
    img.style.top = "100px";

    createResizeHandles(img);
    addElement(img);

  } else {
    // normal open ‚Üí load last saved project (if any)
    const saved = localStorage.getItem("savedDesign");
    if (saved) {
      const project = JSON.parse(saved);
      canvas.innerHTML = project.html;
      canvas.style.width = project.width;
      canvas.style.height = project.height;
      attachElementEvents();
    }
  }
};
</script>

</body>
</html>
