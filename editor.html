<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ultimate Editor v1 (Phase B)</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>

  <style>
    :root{
      --bg:#050712;
      --panel:rgba(15,23,42,0.78);
      --panel2:rgba(2,6,23,0.70);
      --text:#f9fafb;
      --muted:#aab0bd;
      --border:rgba(148,163,184,0.35);
      --chip:rgba(15,23,42,0.55);
      --brand1:#2563eb;
      --brand2:#7c3aed;
      --danger:#ef4444;
      --shadow: 0 18px 55px rgba(0,0,0,0.55);
    }
    :root.light{
      --bg:rgba(255,255,255,0.65);
      --panel:rgba(255,255,255,0.70);
      --panel2:rgba(255,255,255,0.55);
      --text:#0b1220;
      --muted:#475569;
      --border:rgba(148,163,184,0.40);
      --chip:rgba(255,255,255,0.50);
      --shadow: 0 18px 55px rgba(2,6,23,0.20);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Poppins",system-ui,Segoe UI,Roboto,Arial;
      background:var(--bg);
      color:var(--text);
      height:100vh;
      overflow:hidden;
    }

    .app{
      height:100vh;
      display:grid;
      grid-template-rows:56px 1fr;
      grid-template-columns:280px 1fr 320px;
      grid-template-areas:
        "top top top"
        "left center right";
      gap:14px;
      padding:14px;
    }

    /* Top bar */
    .topbar{
      grid-area:top;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 12px;
      border-radius:16px;
      background:var(--panel);
      border:1px solid var(--border);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:700;
      font-size:14px;
      letter-spacing:0.2px;
    }
    .brand-badge{
      width:28px;height:28px;border-radius:10px;
      background: linear-gradient(90deg,var(--brand1),var(--brand2));
      display:grid;place-items:center;
      box-shadow:0 10px 30px rgba(37,99,235,0.25);
      font-size:14px;
    }
    .top-actions{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .btn{
      border:1px solid var(--border);
      background:var(--chip);
      color:var(--text);
      padding:7px 10px;
      border-radius:999px;
      font-size:12px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      user-select:none;
      white-space:nowrap;
    }
    .btn.primary{
      background: linear-gradient(90deg,var(--brand1),var(--brand2));
      border-color: transparent;
      color:#fff;
      font-weight:600;
    }
    .btn.danger{
      background: rgba(239,68,68,0.14);
      border-color: rgba(239,68,68,0.45);
      color: var(--text);
    }
    .btn:disabled{opacity:0.55;cursor:wait}

    /* Panels */
    .panel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:16px;
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .panel-header{
      padding:12px 12px 10px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .panel-title{
      font-weight:700;
      font-size:13px;
    }
    .panel-sub{
      font-size:11px;
      color:var(--muted);
      margin-top:2px;
      font-weight:500;
    }
    .panel-body{
      padding:12px;
      overflow:auto;
      min-height:0;
    }

    /* Left tools */
    .left{grid-area:left}
    .toolgrid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
    }
    .toolbtn{
      border:1px solid var(--border);
      background:var(--chip);
      color:var(--text);
      border-radius:14px;
      padding:10px 10px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      font-size:12px;
      font-weight:600;
      transition:transform 0.12s;
      user-select:none;
    }
    .toolbtn:hover{transform:translateY(-1px)}
    .toolbtn.primary{
      background: linear-gradient(90deg,var(--brand1),var(--brand2));
      border-color:transparent;
      color:#fff;
    }

    .row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
      margin-top:10px;
    }
    label{
      display:block;
      font-size:11px;
      color:var(--muted);
      margin:10px 0 4px;
      font-weight:600;
    }
    input[type="text"], select, input[type="number"]{
      width:100%;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--panel2);
      color:var(--text);
      font-size:12px;
      outline:none;
    }
    input[type="range"]{width:100%}
    input[type="color"]{
      width:100%;
      height:36px;
      border-radius:12px;
      border:1px solid var(--border);
      background:transparent;
      cursor:pointer;
      padding:0;
    }
    .hint{
      font-size:11px;color:var(--muted);
      margin-top:8px;line-height:1.35;
    }

    /* Center canvas */
    .center{grid-area:center; display:flex; align-items:center; justify-content:center; min-height:0;}
    .stage{
      width:min(1100px,100%);
      height:100%;
      border-radius:16px;
      background:rgba(2,6,23,0.25);
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:12px;
      position:relative;
      overflow:hidden;
    }
    .stage.light{
      background:rgba(255,255,255,0.25);
    }
    canvas{
      border-radius:14px;
      box-shadow:0 18px 60px rgba(0,0,0,0.55);
      max-width:100%;
      height:auto;
    }
    .zoomchip{
      position:absolute;
      bottom:12px;
      left:12px;
      display:flex;
      gap:8px;
      align-items:center;
      padding:8px 10px;
      border-radius:999px;
      background:var(--panel);
      border:1px solid var(--border);
      backdrop-filter: blur(14px);
      font-size:11px;
      color:var(--muted);
    }

    /* Right properties */
    .right{grid-area:right}
    .section{
      padding:10px 0 0;
      border-top:1px solid rgba(148,163,184,0.18);
      margin-top:10px;
    }
    .section:first-child{border-top:none;margin-top:0;padding-top:0}
    .inline{
      display:flex; gap:8px; align-items:center;
    }
    .mini{
      font-size:11px;color:var(--muted);
    }
    .layer-item{
      display:flex;align-items:center;justify-content:space-between;
      gap:8px;
      padding:10px 10px;
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--panel2);
      cursor:pointer;
      margin-bottom:8px;
    }
    .layer-item.active{
      outline:2px solid rgba(37,99,235,0.55);
      border-color: rgba(37,99,235,0.55);
    }
    .layer-name{
      font-size:12px;font-weight:600;
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    .layer-actions{
      display:flex;gap:6px;align-items:center;
    }
    .iconbtn{
      width:30px;height:30px;border-radius:10px;
      border:1px solid var(--border);
      background:var(--chip);
      color:var(--text);
      cursor:pointer;
      display:grid;place-items:center;
      font-size:12px;
    }
    .footer-note{
      padding:10px 12px;
      border-top:1px solid var(--border);
      font-size:11px;
      color:var(--muted);
      background:rgba(2,6,23,0.18);
    }
  
    .layer-handle{
      width:28px;height:28px;border-radius:10px;
      border:1px solid var(--border);
      background:rgba(148,163,184,0.10);
      display:grid;place-items:center;
      cursor:grab;
      user-select:none;
      font-size:12px;
      color:var(--muted);
    }
    .layer-item[draggable="true"]{ user-select:none; }
    .layer-item.dragover{
      outline:2px dashed rgba(37,99,235,0.65);
      outline-offset:2px;
    }
    .layer-badge{
      font-size:10px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.28);
      color:var(--muted);
      background:rgba(2,6,23,0.12);
      white-space:nowrap;
    }

  
    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:rgba(2,6,23,0.82);
      color:#fff;
      border:1px solid rgba(148,163,184,0.28);
      padding:10px 12px;
      border-radius:999px;
      font-size:12px;
      z-index:9999;
      box-shadow:0 18px 45px rgba(0,0,0,0.45);
      opacity:0;
      pointer-events:none;
      transition:opacity .2s ease, transform .2s ease;
    }
    :root.light .toast{
      background:rgba(17,24,39,0.88);
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-6px);
    }

  </style>
</head>
<body>

<div class="app">
  <!-- TOP -->
  <div class="topbar">
    <div class="brand">
      <div class="brand-badge">‚ö°</div>
      <div>
        Ultimate Editor <span style="opacity:.75;font-weight:600;">v1</span>
        <div class="panel-sub">Phase B ‚Äî layers ‚Ä¢ save/load ‚Ä¢ snapping ‚Ä¢ polish</div>
      </div>
    </div>

    <div class="top-actions">
      <a class="btn" href="index.html">‚¨Ö Back</a>
      <button class="btn" id="undoBtn">‚Ü© Undo</button>
      <button class="btn" id="redoBtn">‚Ü™ Redo</button>
      <button class="btn" id="duplicateBtn">‚éò Duplicate</button>
      <button class="btn danger" id="deleteBtn">üóë Delete</button>
      <button class="btn" id="toggleThemeBtn">üåô Dark</button>
      <button class="btn" id="saveBtn">üíæ Save</button>
      <button class="btn" id="loadBtn">üìÇ Load</button>
      <button class="btn" id="newBtn">üÜï New</button>
      <button class="btn primary" id="exportBtn">‚¨á Export PNG</button>
      <button class="btn" id="exportJpgBtn">‚¨á Export JPG</button>
    </div>
  </div>

  <!-- LEFT -->
  <div class="panel left">
    <div class="panel-header">
      <div>
        <div class="panel-title">Tools</div>
        <div class="panel-sub">Add elements to your canvas</div>
      </div>
    </div>
    <div class="panel-body">
      <div class="toolgrid">
        <button class="toolbtn primary" id="addTextBtn">‚úèÔ∏è Text</button>
        <button class="toolbtn" id="addRectBtn">‚¨õ Rectangle</button>
        <button class="toolbtn" id="addCircleBtn">‚ö™ Circle</button>
        <button class="toolbtn" id="uploadImgBtn">üñº Image</button>
      </div>

      <label>Canvas preset</label>
      <select id="presetSelect">
        <option value="1080x1080">Instagram Square (1080√ó1080)</option>
        <option value="1080x1920">Story / TikTok (1080√ó1920)</option>
        <option value="1280x720">YouTube Thumbnail (1280√ó720)</option>
        <option value="1200x628">Facebook Post (1200√ó628)</option>
        <option value="800x800">Logo (800√ó800)</option>
        <option value="1920x600">Banner (1920√ó600)</option>
        <option value="2480x3508">A4 Flyer (2480√ó3508)</option>
      </select>

      <div class="row">
        <div>
          <label>Background</label>
          <input type="color" id="bgColor" value="#020617">
        </div>
        <div>
          <label>Grid</label>
          <button class="toolbtn" id="gridBtn">Toggle</button>
        </div>
      </div>

      <label>Zoom</label>
      <input type="range" id="zoomRange" min="25" max="200" value="100">

      <div class="hint">
        Tip: Click an element to edit. Use mouse wheel to scroll. Drag handles to resize. Rotate from corners.
      </div>
    </div>
  </div>

  <!-- CENTER -->
  <div class="center">
    <div class="stage" id="stage">
      <canvas id="c"></canvas>
      <div class="zoomchip"><span>Zoom:</span> <span id="zoomText">100%</span></div>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="panel right">
    <div class="panel-header">
      <div>
        <div class="panel-title">Properties</div>
        <div class="panel-sub">Edit selected element</div>
      </div>
    </div>
    <div class="panel-body">
      <div class="section">
        <div class="mini" id="selectedLabel">Selected: none</div>
      </div>

      <div class="section">
        <label>Fill color</label>
        <input type="color" id="fillColor" value="#ffffff">

        <div class="row">
          <div>
            <label>Opacity</label>
            <input type="range" id="opacityRange" min="0" max="100" value="100">
          </div>
          <div>
            <label>Stroke</label>
            <input type="color" id="strokeColor" value="#000000">
          </div>
        </div>

        <label>Stroke width</label>
        <input type="range" id="strokeWidth" min="0" max="20" value="0">
      </div>

      <div class="section" id="textSection" style="display:none;">
        <label>Font</label>
        <select id="fontFamily">
          <option value="Poppins" selected>Poppins</option>
          <option value="Inter">Inter</option>
          <option value="Montserrat">Montserrat</option>
          <option value="Bebas Neue">Bebas Neue</option>
          <option value="Playfair Display">Playfair Display</option>
        </select>

        <div class="row">
          <div>
            <label>Font size</label>
            <input type="range" id="fontSize" min="10" max="140" value="44">
          </div>
          <div>
            <label>Letter spacing</label>
            <input type="range" id="charSpacing" min="-50" max="400" value="0">
          </div>
        </div>

        <div class="row">
          <button class="toolbtn" id="boldBtn">B</button>
          <button class="toolbtn" id="italicBtn">I</button>
        </div>
      </div>

      <div class="section">
        <label>Arrange</label>
        <div class="row">
          <button class="toolbtn" id="frontBtn">Front</button>
          <button class="toolbtn" id="backBtn">Back</button>
        </div>
        <div class="row">
          <button class="toolbtn" id="centerXBtn">Center X</button>
          <button class="toolbtn" id="centerYBtn">Center Y</button>
        </div>
      </div>

      <div class="section">
        <label>Layers</label>
        <div class="mini">Drag to reorder ‚Ä¢ Click to select</div>
        <div id="layersList"></div>
      </div>
    </div>

    <div class="footer-note">
      Phase B adds layers (rename/hide/lock/reorder), save/load, snapping guides, and premium polish.</div>
  </div>
</div>

<!-- Fonts for selector -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Montserrat:wght@300;400;600;700&family=Bebas+Neue&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">

<script>
  // ---- Load template passed from generator ----
  function getTemplateFromStorage(){
    try{
      const raw = localStorage.getItem("magicTemplate");
      return raw ? JSON.parse(raw) : null;
    }catch(e){
      console.error(e);
      return null;
    }
  }

  // ---- Canvas setup ----
  const canvasEl = document.getElementById('c');
  const stageEl = document.getElementById('stage');

  const template = getTemplateFromStorage();

  // Default preset based on template meta (if available)
  const presetSelect = document.getElementById('presetSelect');
  function inferPreset(metaSize){
    const s = (metaSize || "").toLowerCase();
    if(s.includes("story") || s.includes("tiktok")) return "1080x1920";
    if(s.includes("youtube")) return "1280x720";
    if(s.includes("facebook")) return "1200x628";
    if(s.includes("logo")) return "800x800";
    if(s.includes("banner")) return "1920x600";
    if(s.includes("a4")) return "2480x3508";
    return "1080x1080";
  }
  presetSelect.value = inferPreset(template && template.meta && template.meta.size);

  function setCanvasSize(w,h){
    canvas.setWidth(w);
    canvas.setHeight(h);
    canvas.renderAll();
  }

  // Toast helper (small pop-up)
  const toastEl = document.getElementById('toast');
  let toastTimer = null;
  function toast(msg){
    if(!toastEl) return;
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=> toastEl.classList.remove('show'), 1600);
  }


  const canvas = new fabric.Canvas('c', {
    preserveObjectStacking:true,
    selection:true
  });

  // Fit the canvas into stage visually using CSS scale (zoom feature)
  let visualZoom = 1.0;
  function applyVisualZoom(){
    const pct = Math.round(visualZoom*100);
    document.getElementById('zoomText').textContent = pct + "%";
    canvasEl.style.transformOrigin = "center center";
    canvasEl.style.transform = "scale(" + visualZoom + ")";
  }

  // Grid (simple)
  let gridOn = false;
  const GRID_SIZE = 50;
  const gridLines = [];
  function setGrid(on){
    // remove old
    gridLines.forEach(l => canvas.remove(l));
    gridLines.length = 0;
    gridOn = on;
    if(!on){ canvas.renderAll(); return; }

    const w = canvas.getWidth();
    const h = canvas.getHeight();

    for(let i=GRID_SIZE;i<w;i+=GRID_SIZE){
      const line = new fabric.Line([i,0,i,h], { stroke:'rgba(148,163,184,0.18)', selectable:false, evented:false });
      gridLines.push(line); canvas.add(line);
      canvas.sendToBack(line);
    }
    for(let j=GRID_SIZE;j<h;j+=GRID_SIZE){
      const line = new fabric.Line([0,j,w,j], { stroke:'rgba(148,163,184,0.18)', selectable:false, evented:false });
      gridLines.push(line); canvas.add(line);
      canvas.sendToBack(line);
    }
    canvas.renderAll();
  }

  // Background color
  const bgColor = document.getElementById('bgColor');
  function setBg(color){
    canvas.setBackgroundColor(color, canvas.renderAll.bind(canvas));
  }
  setBg(bgColor.value);
  bgColor.addEventListener('input', ()=> setBg(bgColor.value));

  // Apply preset size
  function applyPresetFromSelect(){
    const [w,h] = presetSelect.value.split("x").map(n=>parseInt(n,10));
    setCanvasSize(w,h);
    setGrid(gridOn);
    // Adjust stage background class for light
    stageEl.classList.toggle("light", document.documentElement.classList.contains("light"));
    applyVisualZoom();
  }
  presetSelect.addEventListener('change', applyPresetFromSelect);

  // Initial canvas size
  applyPresetFromSelect();

  // Add base image if present
  async function addBaseImage(url){
    return new Promise((resolve)=>{
      fabric.Image.fromURL(url, (img)=>{
        // Scale to cover canvas
        const cw = canvas.getWidth();
        const ch = canvas.getHeight();
        const scale = Math.max(cw / img.width, ch / img.height);
        img.set({
          left: cw/2,
          top: ch/2,
          originX:'center',
          originY:'center',
          scaleX: scale,
          scaleY: scale,
          selectable:true
        });
        canvas.add(img);
        canvas.sendToBack(img);
        resolve(img);
      }, { crossOrigin: 'anonymous' });
    });
  }

  if(template && template.image){
    addBaseImage(template.image);
  }

  // ---- History (simple & stable) ----
  const MAX_HISTORY = 40;
  const history = [];
  let historyIndex = -1;

  function pushHistory(){
    const json = canvas.toDatalessJSON(['name','_layerName','_hidden','_locked']);
    // drop redo states
    history.splice(historyIndex+1);
    history.push(json);
    if(history.length > MAX_HISTORY) history.shift();
    historyIndex = history.length - 1;
    updateUndoRedoState();
  }

  function loadHistory(idx){
    if(idx < 0 || idx >= history.length) return;
    const json = history[idx];
    canvas.loadFromJSON(json, ()=>{
      canvas.renderAll();
      setGrid(gridOn);
      historyIndex = idx;
      updateUndoRedoState();
      refreshLayers();
    });
  }

  function updateUndoRedoState(){
    document.getElementById('undoBtn').disabled = !(historyIndex > 0);
    document.getElementById('redoBtn').disabled = !(historyIndex < history.length-1);
  }

  canvas.on('object:added', (e)=>{ if(e.target && e.target._isGuide) return; pushHistory(); refreshLayers(); scheduleAutosave(); });
  canvas.on('object:modified', (e)=>{ if(e.target && e.target._isGuide) return; pushHistory(); refreshLayers(); scheduleAutosave(); });
  canvas.on('object:removed', (e)=>{ if(e.target && e.target._isGuide) return; pushHistory(); refreshLayers(); scheduleAutosave(); });


  // Snapping guides (canvas center + edges)
  const SNAP_PX = 8;
  let guides = [];

  function clearGuides(){
    guides.forEach(g=>canvas.remove(g));
    guides = [];
  }
  function addGuide(line){
    line.selectable = false;
    line.evented = false;
    line.excludeFromExport = true;
    line._isGuide = true;
    guides.push(line);
    canvas.add(line);
    line.moveTo(canvas.getObjects().length-1);
  }

  function snapTo(val, target){
    return Math.abs(val - target) <= SNAP_PX ? target : val;
  }

  canvas.on('object:moving', (opt)=>{
    const obj = opt.target;
    if(!obj || obj._locked) return;

    clearGuides();

    const w = canvas.getWidth();
    const h = canvas.getHeight();

    const br = obj.getBoundingRect(true, true);
    const objCenter = obj.getCenterPoint();

    // Snap center to canvas center
    const cx = w/2;
    const cy = h/2;

    let newCx = snapTo(objCenter.x, cx);
    let newCy = snapTo(objCenter.y, cy);

    if(newCx === cx){
      addGuide(new fabric.Line([cx, 0, cx, h], { stroke:'rgba(37,99,235,0.65)', strokeWidth:1 }));
    }
    if(newCy === cy){
      addGuide(new fabric.Line([0, cy, w, cy], { stroke:'rgba(37,99,235,0.65)', strokeWidth:1 }));
    }

    // Snap edges to canvas edges
    const left = br.left;
    const top = br.top;
    const right = br.left + br.width;
    const bottom = br.top + br.height;

    // Left edge
    if(Math.abs(left - 0) <= SNAP_PX){
      obj.setPositionByOrigin(new fabric.Point(objCenter.x + (0-left), objCenter.y), 'center', 'center');
      addGuide(new fabric.Line([0, 0, 0, h], { stroke:'rgba(148,163,184,0.5)', strokeWidth:1 }));
      return;
    }
    // Right edge
    if(Math.abs(right - w) <= SNAP_PX){
      obj.setPositionByOrigin(new fabric.Point(objCenter.x + (w-right), objCenter.y), 'center', 'center');
      addGuide(new fabric.Line([w, 0, w, h], { stroke:'rgba(148,163,184,0.5)', strokeWidth:1 }));
      return;
    }
    // Top edge
    if(Math.abs(top - 0) <= SNAP_PX){
      obj.setPositionByOrigin(new fabric.Point(objCenter.x, objCenter.y + (0-top)), 'center', 'center');
      addGuide(new fabric.Line([0, 0, w, 0], { stroke:'rgba(148,163,184,0.5)', strokeWidth:1 }));
      return;
    }
    // Bottom edge
    if(Math.abs(bottom - h) <= SNAP_PX){
      obj.setPositionByOrigin(new fabric.Point(objCenter.x, objCenter.y + (h-bottom)), 'center', 'center');
      addGuide(new fabric.Line([0, h, w, h], { stroke:'rgba(148,163,184,0.5)', strokeWidth:1 }));
      return;
    }

    // Apply center snapping (no return)
    if(newCx !== objCenter.x || newCy !== objCenter.y){
      obj.setPositionByOrigin(new fabric.Point(newCx, newCy), 'center', 'center');
    }
  });

  canvas.on('mouse:up', ()=> clearGuides());

  // Prime history once after initial load
  setTimeout(()=>{ pushHistory(); refreshLayers(); }, 400);

  // ---- Selection & Properties ----
  const selectedLabel = document.getElementById('selectedLabel');
  const fillColor = document.getElementById('fillColor');
  const strokeColor = document.getElementById('strokeColor');
  const strokeWidth = document.getElementById('strokeWidth');
  const opacityRange = document.getElementById('opacityRange');

  const textSection = document.getElementById('textSection');
  const fontFamily = document.getElementById('fontFamily');
  const fontSize = document.getElementById('fontSize');
  const charSpacing = document.getElementById('charSpacing');

  function isText(obj){
    return obj && (obj.type === 'textbox' || obj.type === 'text');
  }

  function syncUIFromObject(obj){
    if(!obj){
      selectedLabel.textContent = "Selected: none";
      textSection.style.display = "none";
      return;
    }
    selectedLabel.textContent = "Selected: " + (obj.name || obj.type || "object");

    // fill
    const fill = (obj.fill && typeof obj.fill === "string") ? obj.fill : "#ffffff";
    try{ fillColor.value = fill.startsWith("#") ? fill : "#ffffff"; }catch(e){}
    // stroke
    const stroke = (obj.stroke && typeof obj.stroke === "string") ? obj.stroke : "#000000";
    try{ strokeColor.value = stroke.startsWith("#") ? stroke : "#000000"; }catch(e){}
    strokeWidth.value = obj.strokeWidth || 0;
    opacityRange.value = Math.round((obj.opacity ?? 1) * 100);

    if(isText(obj)){
      textSection.style.display = "block";
      fontFamily.value = obj.fontFamily || "Poppins";
      fontSize.value = obj.fontSize || 44;
      charSpacing.value = obj.charSpacing || 0;
    }else{
      textSection.style.display = "none";
    }
  }

  function applyToActive(fn){
    const obj = canvas.getActiveObject();
    if(!obj) return;
    fn(obj);
    canvas.requestRenderAll();
  }

  canvas.on('selection:created', (e)=> syncUIFromObject(e.selected && e.selected[0]));
  canvas.on('selection:updated', (e)=> syncUIFromObject(e.selected && e.selected[0]));
  canvas.on('selection:cleared', ()=> syncUIFromObject(null));

  fillColor.addEventListener('input', ()=> applyToActive(o=> o.set({fill: fillColor.value})));
  strokeColor.addEventListener('input', ()=> applyToActive(o=> o.set({stroke: strokeColor.value})));
  strokeWidth.addEventListener('input', ()=> applyToActive(o=> o.set({strokeWidth: parseInt(strokeWidth.value,10)})));
  opacityRange.addEventListener('input', ()=> applyToActive(o=> o.set({opacity: parseInt(opacityRange.value,10)/100})));

  fontFamily.addEventListener('change', ()=> applyToActive(o=> {
    if(isText(o)){ o.set({fontFamily: fontFamily.value}); }
  }));
  fontSize.addEventListener('input', ()=> applyToActive(o=> {
    if(isText(o)){ o.set({fontSize: parseInt(fontSize.value,10)}); }
  }));
  charSpacing.addEventListener('input', ()=> applyToActive(o=> {
    if(isText(o)){ o.set({charSpacing: parseInt(charSpacing.value,10)}); }
  }));

  // Bold/Italic toggles
  document.getElementById('boldBtn').addEventListener('click', ()=>{
    applyToActive(o=>{
      if(isText(o)){
        const w = (o.fontWeight === 'bold') ? 'normal' : 'bold';
        o.set({fontWeight:w});
      }
    });
  });
  document.getElementById('italicBtn').addEventListener('click', ()=>{
    applyToActive(o=>{
      if(isText(o)){
        const s = (o.fontStyle === 'italic') ? 'normal' : 'italic';
        o.set({fontStyle:s});
      }
    });
  });

  // ---- Tools actions ----
  function nextName(prefix){
    const n = Math.floor(Math.random()*9000)+1000;
    return prefix + " " + n;
  }

  document.getElementById('addTextBtn').addEventListener('click', ()=>{
    const t = new fabric.Textbox("Edit text",{
      left: canvas.getWidth()*0.18,
      top: canvas.getHeight()*0.12,
      width: Math.min(720, canvas.getWidth()*0.6),
      fill:"#ffffff",
      fontFamily:"Poppins",
      fontSize:64,
      name: nextName("Text")
    });
    canvas.add(t);
    canvas.setActiveObject(t);
  });

  document.getElementById('addRectBtn').addEventListener('click', ()=>{
    const r = new fabric.Rect({
      left: canvas.getWidth()*0.2,
      top: canvas.getHeight()*0.2,
      width: canvas.getWidth()*0.35,
      height: canvas.getHeight()*0.18,
      fill:"#2563eb",
      rx: 20, ry: 20,
      name: nextName("Rect")
    });
    canvas.add(r);
    canvas.setActiveObject(r);
  });

  document.getElementById('addCircleBtn').addEventListener('click', ()=>{
    const c = new fabric.Circle({
      left: canvas.getWidth()*0.25,
      top: canvas.getHeight()*0.25,
      radius: Math.min(canvas.getWidth(),canvas.getHeight())*0.09,
      fill:"#7c3aed",
      name: nextName("Circle")
    });
    canvas.add(c);
    canvas.setActiveObject(c);
  });

  document.getElementById('uploadImgBtn').addEventListener('click', ()=>{
    const input = document.createElement('input');
    input.type='file';
    input.accept='image/*';
    input.onchange = (e)=>{
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        fabric.Image.fromURL(reader.result, (img)=>{
          img.set({
            left: canvas.getWidth()*0.2,
            top: canvas.getHeight()*0.2,
            name: nextName("Image")
          });
          img.scaleToWidth(Math.min(600, canvas.getWidth()*0.5));
          canvas.add(img);
          canvas.setActiveObject(img);
        });
      };
      reader.readAsDataURL(file);
    };
    input.click();
  });

  // Duplicate / Delete
  document.getElementById('duplicateBtn').addEventListener('click', ()=>{
    const obj = canvas.getActiveObject();
    if(!obj) return;
    obj.clone((cloned)=>{
      cloned.set({ left: obj.left + 20, top: obj.top + 20, name: nextName((obj.name || obj.type || "Copy")) });
      canvas.add(cloned);
      canvas.setActiveObject(cloned);
    });
  });

  document.getElementById('deleteBtn').addEventListener('click', ()=>{
    const obj = canvas.getActiveObject();
    if(!obj) return;
    canvas.remove(obj);
    canvas.discardActiveObject();
    canvas.requestRenderAll();
    syncUIFromObject(null);
  });

  // Arrange
  document.getElementById('frontBtn').addEventListener('click', ()=>{ const o=canvas.getActiveObject(); if(o) canvas.bringToFront(o); });
  document.getElementById('backBtn').addEventListener('click', ()=>{ const o=canvas.getActiveObject(); if(o) canvas.sendToBack(o); });

  // Align
  document.getElementById('centerXBtn').addEventListener('click', ()=>{
    const o = canvas.getActiveObject(); if(!o) return;
    o.set({ left: (canvas.getWidth()/2) - (o.getScaledWidth()/2) });
    canvas.requestRenderAll();
  });
  document.getElementById('centerYBtn').addEventListener('click', ()=>{
    const o = canvas.getActiveObject(); if(!o) return;
    o.set({ top: (canvas.getHeight()/2) - (o.getScaledHeight()/2) });
    canvas.requestRenderAll();
  });

  // Undo / Redo
  document.getElementById('undoBtn').addEventListener('click', ()=> loadHistory(historyIndex-1));
  document.getElementById('redoBtn').addEventListener('click', ()=> loadHistory(historyIndex+1));

  // Export PNG
  document.getElementById('exportBtn').addEventListener('click', ()=>{
    const dataUrl = canvas.toDataURL({ format:'png', multiplier: 2 });
    const a = document.createElement('a');
    a.href = dataUrl;
    a.download = 'template.png';
    a.click();
  });


  // Export JPG
  document.getElementById('exportJpgBtn').addEventListener('click', ()=>{
    const dataUrl = canvas.toDataURL({ format:'jpeg', quality: 0.95, multiplier: 2 });
    const a = document.createElement('a');
    a.href = dataUrl;
    a.download = 'template.jpg';
    a.click();
  });

  // Save / Load (local browser storage)
  const SAVE_KEY = "ultimate_editor_design_v1";
  const saveBtn = document.getElementById('saveBtn');
  const loadBtn = document.getElementById('loadBtn');
  const newBtn  = document.getElementById('newBtn');

  function sanitizeForSave(json){
    // Avoid saving external image data URLs too large by default (keep as is for now).
    return json;
  }

  function saveDesign(silent=false){
    const json = canvas.toJSON(['name','_layerName','_hidden','_locked']);
    localStorage.setItem(SAVE_KEY, JSON.stringify(sanitizeForSave(json)));
    if(!silent) toast("Saved ‚úÖ");
  }

  function loadDesign(){
    const raw = localStorage.getItem(SAVE_KEY);
    if(!raw){ toast("No saved design found"); return; }
    try{
      const json = JSON.parse(raw);
      canvas.loadFromJSON(json, ()=>{
        // Re-apply lock/hidden state
        canvas.getObjects().forEach(o=>{
          if(o._hidden){ o.visible=false; }
          if(o._locked){
            o.selectable=false; o.evented=false; o.hasControls=false;
            o.lockMovementX=o.lockMovementY=o.lockRotation=o.lockScalingX=o.lockScalingY=true;
          }
        });
        canvas.requestRenderAll();
        pushHistory();
        refreshLayers();
        toast("Loaded ‚úÖ");
      });
    }catch(e){
      console.error(e);
      toast("Load failed");
    }
  }

  function newDesign(){
    if(!confirm("Start a new blank design? This will clear the canvas.")) return;
    canvas.getObjects().slice().forEach(o=>{
      if(o !== canvas.backgroundImage) canvas.remove(o);
    });
    canvas.discardActiveObject();
    canvas.requestRenderAll();
    pushHistory();
    refreshLayers();
    toast("New canvas ‚úÖ");
  }

  saveBtn.addEventListener('click', saveDesign);
  loadBtn.addEventListener('click', loadDesign);
  newBtn.addEventListener('click', newDesign);

  // Auto-save softly after changes (every ~1s idle)
  let autosaveTimer = null;
  function scheduleAutosave(){
    clearTimeout(autosaveTimer);
    autosaveTimer = setTimeout(()=> {
      try{ saveDesign(true); }catch(_){}
    }, 1200);
  }

  // Zoom
  const zoomRange = document.getElementById('zoomRange');
  zoomRange.addEventListener('input', ()=>{
    visualZoom = parseInt(zoomRange.value,10)/100;
    applyVisualZoom();
  });
  applyVisualZoom();

  // Grid
  document.getElementById('gridBtn').addEventListener('click', ()=> setGrid(!gridOn));

  // Theme toggle
  const toggleThemeBtn = document.getElementById('toggleThemeBtn');
  function syncThemeBtn(){
    const light = document.documentElement.classList.contains('light');
    toggleThemeBtn.textContent = light ? "‚òÄÔ∏è Light" : "üåô Dark";
    stageEl.classList.toggle("light", light);
  }
  toggleThemeBtn.addEventListener('click', ()=>{
    document.documentElement.classList.toggle('light');
    syncThemeBtn();
  });
  syncThemeBtn();

  // Layers list (select only, Phase 1)
  const layersList = document.getElementById('layersList');

  function getLayerLabel(obj){
    return (obj && (obj.name || obj._layerName || obj.type || "Layer")) || "Layer";
  }

  function setLayerLabel(obj, label){
    if(!obj) return;
    obj._layerName = String(label || "").trim() || (obj.type || "Layer");
    refreshLayers();
  }

  function toggleHidden(obj){
    if(!obj) return;
    const hidden = !!obj._hidden;
    obj._hidden = !hidden;
    obj.visible = hidden; // if hidden -> visible false, else true
    obj.evented = !obj._hidden && !obj._locked;
    if(obj._hidden && canvas.getActiveObject() === obj){
      canvas.discardActiveObject();
    }
    canvas.requestRenderAll();
    refreshLayers();
  }

  function toggleLocked(obj){
    if(!obj) return;
    obj._locked = !obj._locked;
    obj.selectable = !obj._locked;
    obj.evented = !obj._locked && !obj._hidden;
    obj.hasControls = !obj._locked;
    obj.lockMovementX = obj._locked;
    obj.lockMovementY = obj._locked;
    obj.lockRotation = obj._locked;
    obj.lockScalingX = obj._locked;
    obj.lockScalingY = obj._locked;
    if(obj._locked && canvas.getActiveObject() === obj){
      // keep active, but controls will hide
    }
    canvas.requestRenderAll();
    refreshLayers();
  }

  function moveLayerToIndex(obj, newIndexFromBottom){
    // Fabric indices are from bottom (0) to top (n-1)
    const all = canvas.getObjects();
    const cur = all.indexOf(obj);
    if(cur < 0) return;
    const clamped = Math.max(0, Math.min(all.length-1, newIndexFromBottom));
    obj.moveTo(clamped);
    canvas.requestRenderAll();
  }

  function refreshLayers(){
    const all = canvas.getObjects().filter(o => o !== canvas.backgroundImage);
    // show TOP first (reverse)
    const topFirst = all.slice().reverse();
    layersList.innerHTML = "";

    topFirst.forEach((obj, topIndex)=>{
      const div = document.createElement('div');
      div.className = 'layer-item' + (obj === canvas.getActiveObject() ? ' active' : '');
      div.setAttribute('draggable', 'true');

      const handle = document.createElement('div');
      handle.className = 'layer-handle';
      handle.title = 'Drag to reorder';
      handle.textContent = '‚ãÆ‚ãÆ';

      const nameWrap = document.createElement('div');
      nameWrap.style.display = 'flex';
      nameWrap.style.flexDirection = 'column';
      nameWrap.style.gap = '2px';
      nameWrap.style.minWidth = '0';

      const name = document.createElement('div');
      name.className = 'layer-name';
      name.textContent = getLayerLabel(obj);

      const badges = document.createElement('div');
      badges.style.display = 'flex';
      badges.style.gap = '6px';
      badges.style.flexWrap = 'wrap';

      if(obj._locked){
        const b = document.createElement('span'); b.className='layer-badge'; b.textContent='Locked';
        badges.appendChild(b);
      }
      if(obj._hidden){
        const b = document.createElement('span'); b.className='layer-badge'; b.textContent='Hidden';
        badges.appendChild(b);
      }

      nameWrap.appendChild(name);
      if(badges.childNodes.length) nameWrap.appendChild(badges);

      const actions = document.createElement('div');
      actions.className = 'layer-actions';

      const renameBtn = document.createElement('button');
      renameBtn.className = 'iconbtn';
      renameBtn.title = 'Rename';
      renameBtn.textContent = '‚úé';
      renameBtn.onclick = (e)=>{
        e.stopPropagation();
        const next = prompt("Rename layer:", getLayerLabel(obj));
        if(next !== null) setLayerLabel(obj, next);
      };

      const hideBtn = document.createElement('button');
      hideBtn.className = 'iconbtn';
      hideBtn.title = obj._hidden ? 'Show' : 'Hide';
      hideBtn.textContent = obj._hidden ? 'üëÅ' : 'üö´';
      hideBtn.onclick = (e)=>{ e.stopPropagation(); toggleHidden(obj); };

      const lockBtn = document.createElement('button');
      lockBtn.className = 'iconbtn';
      lockBtn.title = obj._locked ? 'Unlock' : 'Lock';
      lockBtn.textContent = obj._locked ? 'üîì' : 'üîí';
      lockBtn.onclick = (e)=>{ e.stopPropagation(); toggleLocked(obj); };

      const up = document.createElement('button');
      up.className = 'iconbtn';
      up.title = 'Bring forward';
      up.textContent = '‚¨Ü';
      up.onclick = (e)=>{ e.stopPropagation(); canvas.bringForward(obj); canvas.requestRenderAll(); refreshLayers(); };

      const down = document.createElement('button');
      down.className = 'iconbtn';
      down.title = 'Send backward';
      down.textContent = '‚¨á';
      down.onclick = (e)=>{ e.stopPropagation(); canvas.sendBackwards(obj); canvas.requestRenderAll(); refreshLayers(); };

      actions.appendChild(renameBtn);
      actions.appendChild(hideBtn);
      actions.appendChild(lockBtn);
      actions.appendChild(up);
      actions.appendChild(down);

      div.appendChild(handle);
      div.appendChild(nameWrap);
      div.appendChild(actions);

      div.onclick = ()=>{
        if(obj._hidden) toggleHidden(obj); // unhide on click
        canvas.setActiveObject(obj);
        canvas.requestRenderAll();
        syncUIFromObject(obj);
        refreshLayers();
      };

      // Drag reorder
      div.addEventListener('dragstart', (e)=>{
        e.dataTransfer.setData('text/plain', String(topIndex));
        e.dataTransfer.effectAllowed = 'move';
      });
      div.addEventListener('dragover', (e)=>{ e.preventDefault(); div.classList.add('dragover'); });
      div.addEventListener('dragleave', ()=> div.classList.remove('dragover'));
      div.addEventListener('drop', (e)=>{
        e.preventDefault();
        div.classList.remove('dragover');
        const fromTopIndex = parseInt(e.dataTransfer.getData('text/plain'), 10);
        if(isNaN(fromTopIndex)) return;

        const fromObj = topFirst[fromTopIndex];
        const toObj = obj;
        if(!fromObj || !toObj || fromObj === toObj) return;

        // Determine new index in bottom-based coordinates
        const allBottom = canvas.getObjects().filter(o => o !== canvas.backgroundImage);
        const fromBottomIndex = allBottom.indexOf(fromObj);
        const toBottomIndex = allBottom.indexOf(toObj);

        // Move fromObj to toBottomIndex, then adjust if needed
        moveLayerToIndex(fromObj, toBottomIndex);
        refreshLayers();
      });

      layersList.appendChild(div);
    });
  }


  // Keyboard shortcuts (basic)
  window.addEventListener('keydown', (e)=>{
    const obj = canvas.getActiveObject();
    if(e.key === "Delete" || e.key === "Backspace"){
      if(obj){ canvas.remove(obj); canvas.discardActiveObject(); canvas.requestRenderAll(); }
    }
    if((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==="z"){
      e.preventDefault();
      loadHistory(historyIndex-1);
    }
    if((e.ctrlKey || e.metaKey) && (e.key.toLowerCase()==="y" || (e.shiftKey && e.key.toLowerCase()==="z"))){
      e.preventDefault();
      loadHistory(historyIndex+1);
    }
    if((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==="d"){
      e.preventDefault();
      document.getElementById('duplicateBtn').click();
    }
  });
</script>

  <div id="toast" class="toast"></div>
</body>
</html>
