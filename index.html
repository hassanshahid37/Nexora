









<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nexora â€“ AI Creative Director â€“ Dark Premium AI Template Generator</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary:#0b5fff;
      --muted:#aab0bd;

      /* DARK (transparent) */
      --bg:#050712;
      --panel:rgba(15,18,32,.55);
      --panel2:rgba(15,18,32,.35);
      --stroke:rgba(255,255,255,.10);
      --text:#f6f7fb;

      --shadow:0 18px 50px rgba(0,0,0,.45);
      --radius:18px;
    }
    [data-theme="light"]{
      --bg:#f5f7ff;
      --panel:rgba(255,255,255,.72);
      --panel2:rgba(255,255,255,.55);
      --stroke:rgba(10,20,60,.12);
      --text:#0b1020;
      --shadow:0 18px 40px rgba(10,20,60,.18);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(11,95,255,.22), transparent 60%),
        radial-gradient(900px 600px at 85% 20%, rgba(136,71,255,.18), transparent 55%),
        radial-gradient(900px 600px at 35% 95%, rgba(0,225,255,.10), transparent 55%),
        var(--bg);
      overflow-x:hidden;
    }

    .wrap{max-width:1200px;margin:0 auto;padding:26px 18px 60px}
    header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 16px;border:1px solid var(--stroke);
      background:var(--panel);
      backdrop-filter: blur(16px);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      position:sticky;top:14px;z-index:20;
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:38px;height:38px;border-radius:12px;
      background:linear-gradient(135deg, rgba(11,95,255,.95), rgba(136,71,255,.88));
      box-shadow:0 10px 26px rgba(11,95,255,.28);
      border:1px solid rgba(255,255,255,.18);
    }
    .brand h1{font-size:15px;margin:0;font-weight:700;letter-spacing:.2px}
    .brand p{margin:0;color:var(--muted);font-size:12px}
    .actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .btn{
      appearance:none;border:1px solid var(--stroke);
      background:var(--panel2);
      color:var(--text);
      padding:10px 12px;border-radius:14px;
      font-weight:600;font-size:12.5px;
      cursor:pointer;transition:.15s ease;
      backdrop-filter: blur(16px);
      display:inline-flex;align-items:center;gap:8px;
    }
    .btn:hover{transform:translateY(-1px);border-color:rgba(11,95,255,.35)}
    .btn.primary{
      background:linear-gradient(135deg, rgba(11,95,255,.95), rgba(136,71,255,.85));
      border-color:rgba(255,255,255,.14);
      box-shadow:0 12px 30px rgba(11,95,255,.22);
    }
    .btn:active{transform:translateY(0px)}
    .tag{
      padding:6px 10px;border:1px solid var(--stroke);
      background:var(--panel2);
      border-radius:999px;font-size:12px;color:var(--muted)
    }

    main{margin-top:18px;display:grid;grid-template-columns:1.1fr .9fr;gap:18px}
    .card{
      border:1px solid var(--stroke);
      background:var(--panel);
      backdrop-filter: blur(16px);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .hero{padding:26px}
    .hero h2{margin:0 0 10px;font-size:34px;line-height:1.12}
    .hero p{margin:0 0 16px;color:var(--muted);font-size:14px;line-height:1.55}
    .grid{
      display:grid;grid-template-columns:repeat(3,minmax(0,1fr));
      gap:12px;margin-top:18px
    }
    .tile{
      padding:14px;border:1px solid var(--stroke);
      background:var(--panel2);
      border-radius:16px;
      min-height:92px;
      position:relative;
      overflow:hidden;
    }
    .thumb{
      height:84px;
      border-radius:12px;
      margin-bottom:10px;
      position:relative;
      background:
        radial-gradient(160px 80px at 20% 20%, rgba(11,95,255,.24), transparent 60%),
        radial-gradient(140px 90px at 90% 35%, rgba(136,71,255,.18), transparent 60%),
        linear-gradient(135deg, rgba(255,255,255,.12), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.14);
    }
    [data-theme="light"] .thumb{
      background:
        radial-gradient(160px 80px at 20% 20%, rgba(11,95,255,.14), transparent 60%),
        radial-gradient(140px 90px at 90% 35%, rgba(136,71,255,.10), transparent 60%),
        linear-gradient(135deg, rgba(10,20,60,.06), rgba(10,20,60,.02));
      border:1px solid rgba(10,20,60,.12);
    }
    .mini{
      position:absolute;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.10);
    }
    [data-theme="light"] .mini{
      border:1px solid rgba(10,20,60,.12);
      background:rgba(10,20,60,.06);
    }
    .tile b{display:block;font-size:12.5px;margin-bottom:6px}
    .tile span{font-size:12px;color:var(--muted);line-height:1.35}
    .right{padding:18px}
    .right h3{margin:2px 0 10px;font-size:14px}
    .field{margin:10px 0}
    .field label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    .field input,.field select,.field textarea{
      width:100%;padding:11px 12px;border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.10);
      color:var(--text);
      outline:none;
    }
    [data-theme="light"] .field input,
    [data-theme="light"] .field select,
    [data-theme="light"] .field textarea{
      background:rgba(255,255,255,.50);
    }
    textarea{min-height:96px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .foot{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:14px 18px;border-top:1px solid var(--stroke);
      color:var(--muted);font-size:12px
    }

    @media (max-width: 980px){
      main{grid-template-columns:1fr}
      .hero h2{font-size:28px}
      .grid{grid-template-columns:repeat(2,minmax(0,1fr))}
    }
    @media (max-width: 520px){
      header{position:relative;top:auto}
      .grid{grid-template-columns:1fr}
      .row{grid-template-columns:1fr}
    }
  
    /* FIX: dropdown options visibility + borders */
    
    select{
      border:1px solid rgba(10,20,60,.45);
      background:#ffffff;
      color:#0b1020;
    }
    select option{
      color:#0b1020;
      background:#ffffff;
    }
    [data-theme="dark"] select{
      border:1px solid rgba(255,255,255,.25);
      background:#0b1020;
      color:#ffffff;
    }
    [data-theme="dark"] select option{
      color:#ffffff;
      background:#0b1020;
    }
    
    [data-theme="dark"] select option{color:#ffffff;background:#0b1020;}
    
/* === Nexora Canva-style previews === */
.tile .preview-canvas{
  position: relative;
  height: 120px;
  border-radius: 14px;
  overflow: hidden;
  background: rgba(255,255,255,.06);
  border: 1px solid var(--stroke);
  margin-bottom: 10px;
}
.tile .preview-canvas .pv-text{
  position:absolute;
  left:12px;
  right:12px;
  font-weight:700;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}


/* === Header: match editor branding (icon + stacked text) === */
.brand{display:flex;align-items:center;gap:12px}
.brandText{display:flex;flex-direction:column;gap:2px;min-width:0}
.brandText h1{margin:0;font-size:15px;font-weight:700;letter-spacing:.2px;line-height:1.1}
.brandText p{margin:0}

/* editor-like circular badge with the NEW official logo cropped to the N mark */
.logo{
  width:44px;
  height:44px;
  border-radius:14px;
  background:
    rgba(10,14,30,.92);
  border:1px solid rgba(255,255,255,.14);
  box-shadow:0 10px 26px rgba(0,0,0,.45);
  flex-shrink:0;
}

/* stacked lines like editor */
.brandTag{color:var(--muted);font-size:12px;line-height:1.2}
.brandSub{color:var(--muted);font-size:12px;line-height:1.2;opacity:.95}

/* keep header height stable on small screens */
@media (max-width:520px){
  .logo{width:40px;height:40px;border-radius:12px}
  .brandText h1{font-size:14px}
}


/* === Nexora FINAL UI PREVIEW FIX === */
.template-card,
.template-tile,
.preview-card {
  aspect-ratio: 1 / 1;
}
.template-preview,
.preview-canvas {
  width: 100%;
  height: 100%;
}
/* ================================= */


/* === Nexora FINAL UI PREVIEW FIX v2 (square tiles) ===
   Real preview container is `.tile .preview-canvas`.
   We force it to 1:1 so 1080x1080 canvases render legibly.
*/
.tile .preview-canvas{
  aspect-ratio: 1 / 1;
  height: auto !important;          /* override previous fixed heights */
  width: 100% !important;
}
/* Optional: keep tiles from collapsing */
.tile{ min-height: unset; }
/* ================================================ */

</style>

    

<!-- YT Preview Shell Fix (16:9 full-bleed) -->
<style>
  /* Generic preview card selectors (defensive) */
  .preview-card, .template-card, .card {
    box-sizing: border-box;
  }

  /* When YT mode is active, remove card chrome and force 16:9 */
  .yt-preview .preview-card,
  .yt-preview .template-card,
  .yt-preview .card {
    padding: 0 !important;
    border-radius: 0 !important;
    background: transparent !important;
  }

  /* Force a 16:9 viewport for thumbnails */
  .yt-preview .preview-viewport,
  .yt-preview .canvas,
  .yt-preview .thumb,
  .yt-preview .preview {
    aspect-ratio: 16 / 9;
    width: 100% !important;
    height: auto !important;
    max-width: 100%;
    overflow: hidden;
  }

/* === Nexora FINAL UI PREVIEW FIX === */
.template-card,
.template-tile,
.preview-card {
  aspect-ratio: 1 / 1;
}
.template-preview,
.preview-canvas {
  width: 100%;
  height: 100%;
}
/* ================================= */


/* === Nexora FINAL UI PREVIEW OVERRIDE (vFinal) ===
   Authoritative, last-wins rule: square + readable size.
*/
.tile .preview-canvas{
  width: 100% !important;
  aspect-ratio: 1 / 1 !important;
  height: auto !important;          /* kills any fixed height */
  min-height: 220px !important;     /* avoids render-before-layout tiny boxes */
  display: block !important;
}
/* ================================================= */

</style>


</head>

<body data-theme="dark">
  <div class="wrap">
    <header>
      
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="brandText">
          <h1>Nexora</h1>
          <p class="brandTag">AI Creative Director</p>
          <p class="brandSub">Dark Premium AI Template Generator + Ultimate Editor v1</p>
        </div>
      </div>
    

      <div class="actions">
        <span class="tag">No auth â€¢ No subscriptions â€¢ Netlify-ready</span>
        <button class="btn" id="themeBtn" type="button">ðŸŒ— Toggle theme</button>
        <button class="btn primary" id="openEditor" type="button">Open Editor</button>
        <button class="btn" id="btnTemplates" type="button">ðŸ“š Library</button>
        <button class="btn" id="btnAnimate" type="button">ðŸŽ¬ Animate</button>

      </div>
    </header>

    <main>
      <section class="card hero">
        <h2>Create hundreds of premium templates in minutes.</h2>
        <p>
          Generate designs fast, then fineâ€‘tune in the editor with a Canvaâ€‘style workflow:
          layers, properties, snap grid, multiâ€‘select, duplicate, undo/redo, and autosave.
        </p>

        <div class="actions" style="margin-top:14px">
          <button class="btn primary" id="generateBtn" type="button">âš¡ Generate Templates</button>
        <button class="btn" id="newLayoutBtn" type="button">ðŸ§© New Layout</button>
        <button class="btn" id="newStyleBtn" type="button">ðŸŽ¨ New Style</button>

          <button class="btn" id="exportBtn" type="button">â¬‡ Export List (JSON)</button>
        </div>

        <div class="grid" id="previewGrid" aria-live="polite" style="margin-top:18px"></div>
      </section>

      <aside class="card right">
        <h3>Generation settings</h3>

        <div class="field">
          <label>Category</label>
          <select id="cat">
            <option>Instagram Post</option>
            <option>YouTube Thumbnail</option>
            <option>Flyer</option>
            <option>Business Card</option>
            <option>Logo</option>
            <option>Presentation Slide</option>
            <option>Resume</option>
            <option>Poster</option>
            <option>Story</option>
          </select>
        </div>

        <div class="row">
          <div class="field">
            <label>Count (max 200)</label>
            <input id="count" type="number" min="1" max="200" value="24" />
          </div>
          <div class="field">
            <label>Style</label>
            <select id="style">
              <option>Dark Premium</option>
              <option>Light Minimal</option>
              <option>Neon</option>
              <option>Glassmorphism</option>
              <option>Corporate</option>
            </select>
          </div>
        </div>

        <div class="field">
          <label>Prompt</label>
          <textarea id="prompt" placeholder="e.g., Premium real-estate carousel for luxury apartments, bold typography, modern shapes..."></textarea>
        </div>

        <div class="field">
          <label>Notes</label>
          <input id="notes" placeholder="(optional) brand name, colors, etc." />
        </div>

        <div class="foot">
          <span>Tip: Click any preview to open it in the Editor.</span>
          <span id="status">Ready</span>
        </div>
      </aside>
    </main>
  </div>

  <!-- Runtime renderers (required for real thumbnails on homepage) -->
  <script src="./preview-template-contract.js"></script>
  <script src="./preview-normalization-engine.js"></script>
  <script src="./preview-renderer.js"></script>
  <script src="./template-output-controller.js"></script>

<script>
  const $ = (s)=>document.querySelector(s);
  const grid = $("#previewGrid");
  const statusEl = $("#status");

  // Global AI commit lock: once AI templates are committed, seed/legacy renders must never run again.
  window.__NEXORA_AI_COMMITTED__ = window.__NEXORA_AI_COMMITTED__ || false;

  function setTheme(next){
    document.body.setAttribute("data-theme", next);
    localStorage.setItem("templify_theme", next);
  }
  function toggleTheme(){
    const cur = document.body.getAttribute("data-theme") || "dark";
    setTheme(cur === "dark" ? "light" : "dark");
  }

  // Phase G (Generator-side invisible editor helpers)
  // Ensures prompt meaningfully maps into template elements BEFORE rendering/opening editor.
  function applyPromptToTemplate(tpl, prompt){
    if(!tpl || !prompt) return tpl;
    const p = String(prompt).trim();
    if(!p) return tpl;

    // Title
    tpl.title = tpl.title && tpl.title.startsWith("Instagram") ? p.slice(0, 32) : (tpl.title || p.slice(0, 32));

    // Elements mapping
    const els = Array.isArray(tpl.elements) ? tpl.elements : [];
    // FIX: use the correct local list variable (was `list` which caused ReferenceError)
    const heading = els.find(e => ["heading","subhead"].includes(String(e.type||"").toLowerCase()))
        || els.find(e => String(e.type||"").toLowerCase()==="text" && (Number(e.weight||0) >= 800 || Number(e.size||0) >= 46));
    if(heading) heading.title = p.slice(0, 60);

    const body = els.find(e => String(e.type||"").toLowerCase()==="text");
    if(body) body.sub = p.slice(0, 90);

    return tpl;
  }

  function applyPromptToTemplates(templates, prompt){
    if(!Array.isArray(templates)) return templates;
    templates.forEach(t => applyPromptToTemplate(t, prompt));
    return templates;
  }

  // Expose for debugging / future bridge (non-destructive)
  window.NEXORA = window.NEXORA || {};
  window.NEXORA.applyPromptToTemplates = applyPromptToTemplates;



// Unified preview router (no UI changes):
// P8 Phase-3 requirement: when contract exists, previews must reflect zone-executed geometry.
function __synthContentFromElements(tpl){
  try{
    const els = Array.isArray(tpl?.elements) ? tpl.elements : [];
    if(!els.length) return null;

    const normType = (e)=>String(e?.type||"").toLowerCase();
    const pick = (types)=>els.find(e=>types.includes(normType(e)));

    const heading = pick(["headline","heading","h1","title"]) || els.find(e=>normType(e)==="text" && (Number(e.weight||0)>=800 || Number(e.size||0)>=46));
    const sub = pick(["subhead","subheadline"]) || els.find(e=>normType(e)==="text" && e!==heading);
    const cta = pick(["cta","button"]);
    const badge = pick(["badge","pill","chip"]);
    const img = pick(["image","photo"]);

    const headlineText = String(heading?.text ?? heading?.title ?? heading?.label ?? "").trim();
    const subText = String(sub?.sub ?? sub?.text ?? sub?.title ?? sub?.subtitle ?? "").trim();
    const ctaText = String(cta?.text ?? cta?.title ?? "").trim();
    const badgeText = String(badge?.text ?? badge?.title ?? "").trim();
    const imageUrl = String(img?.src ?? img?.url ?? img?.imageUrl ?? "").trim();

    const out = {};
    if(headlineText) out.headline = headlineText;
    if(subText) out.subhead = subText;
    if(ctaText) out.cta = ctaText;
    if(badgeText) out.badge = badgeText;
    if(imageUrl) out.imageUrl = imageUrl;

    return Object.keys(out).length ? out : null;
  } catch (e) { return null; }
}

// Prefer Preview Renderer v1 when contract exists; synthesize content if missing.
function renderThumb(thumb, tplOrElements, bg){
  if(!thumb) return;
  try{
    const tpl = Array.isArray(tplOrElements)
      ? { elements: tplOrElements, canvas: { w: 980, h: 620 } }
      : (tplOrElements || {});

    // API output may be:
    // - Spine-shaped: { contract, content }
    // - Flat: { canvas, elements }
    // Always prefer NexoraPreview when available, and let it auto-adapt.
    if(window.NexoraPreview && typeof window.NexoraPreview.renderTo === "function"){
      const content = tpl.content || tpl.doc?.content || __synthContentFromElements(tpl);

      thumb.innerHTML = "";

      // If we have a contract+content, pass in spine payload.
      if(tpl && tpl.contract && content && typeof content === "object"){
        window.NexoraPreview.renderTo(thumb, { contract: tpl.contract, content, meta: tpl.meta || tpl.doc?.meta });
        if(thumb.childNodes && thumb.childNodes.length > 0) return;
        // fall through on empty render
        thumb.innerHTML = "";
      }

      // Otherwise, pass the template as-is (flat mode). Preview renderer will normalize.
      window.NexoraPreview.renderTo(thumb, Object.assign({ content }, tpl));
      if(thumb.childNodes && thumb.childNodes.length > 0) return;

      // If renderer produced nothing, fall through to legacy draw.
      thumb.innerHTML = "";
    }
  }catch(e){}
}



  function seedTemplates(n){
  // PLACEHOLDER-ONLY: keep template boxes visible, but DO NOT generate mock/demo previews.
  // Real previews must come ONLY from /api/generate output.
  if (window.__NEXORA_AI_COMMITTED__) return;

  const gridEl = document.getElementById("previewGrid");
  if(!gridEl) return;

  const count = Math.max(1, Math.min(parseInt(n || 6, 10) || 6, 24));

  // If we already have real templates rendered, do nothing.
  if (Array.isArray(window.__lastTemplates) && window.__lastTemplates.length) return;

  // If grid already has tiles, keep them (never blank).
  const existingTiles = gridEl.querySelectorAll(".tile");
  if (existingTiles && existingTiles.length) return;

  const category = document.getElementById("cat")?.value || "Template";

  const frag = document.createDocumentFragment();
  for(let i=0;i<count;i++){
    const div = document.createElement("div");
    div.className = "tile";
    div.tabIndex = -1; // placeholders are not clickable
    div.innerHTML = `
      <div class="preview-canvas" aria-hidden="true"></div>
      <b>${category} #${i+1}</b>
      <span>Generate to see real AI previews</span>
    `;
    frag.appendChild(div);
  }

  gridEl.appendChild(frag);
}

  // Expose for cross-script access
  window.seedTemplates = seedTemplates;


function toEditorTemplate(tpl){
    if(!tpl) return tpl;
    const elements = Array.isArray(tpl.elements) ? tpl.elements : [];
    const looksLikeDesignJS = elements.some(e => ["bg","photo","pill","chip"].includes(String(e.type||"").toLowerCase()) || ("text" in (e||{}) && !("title" in (e||{}))));
    if(!looksLikeDesignJS) return tpl;

    const W = Number(tpl?.canvas?.w || 980);
    const H = Number(tpl?.canvas?.h || 620);

    const outEls = elements.map((e, idx)=> {
      const type = String(e.type||"card").toLowerCase();
      const id = e.id || (globalThis.crypto?.randomUUID?.() || (Math.random().toString(16).slice(2) + Date.now().toString(16)));
      const x = Number(e.x ?? 80), y = Number(e.y ?? 80);
      const w = Number(e.w ?? 320), h = Number(e.h ?? 120);

      let title = "";
      let sub = "";

      if(type === "text"){
        title = String(e.text ?? "");
        sub = "";
      }else if(["pill","badge","chip"].includes(type)){
        title = String(e.text ?? e.title ?? "BADGE");
      }else if(type === "button" || type === "cta"){
        title = String(e.text ?? e.title ?? "CTA");
      }else if(type === "photo" || type === "image"){
        title = "IMAGE";
        sub = String(e.label ?? "");
      }else if(type === "bg"){
        title = "BG";
      }else if(type === "shape"){
        title = "SHAPE";
      }else{
        title = String(e.title ?? "");
        sub = String(e.sub ?? "");
      }

      return { id, type, x, y, w, h, title, sub };
    });

    return {
      id: tpl.id || `tpl_${Date.now()}`,
      title: tpl.title || "Template",
      description: tpl.description || tpl.subtitle || "",
      category: tpl.category || "Instagram Post",
      style: tpl.style || "Dark Premium",
      bg: tpl.bg || null,
      canvas: tpl.canvas || { w: W, h: H },
      contract: tpl.contract || null,
      content: tpl.content || null,
      doc: tpl.doc || null,
      elements: outEls
    };
  }

function openEditorWith(payload){
    // payload can be {cat,style,i} OR a full template object
    const cat = payload?.category || payload?.cat || $("#cat").value;
    const style = payload?.style || $("#style").value;
let tpl = payload?.elements ? toEditorTemplate(payload) : null;
    // If called with settings-only payload (e.g., Open Editor button), default to latest generated template #1
    if(!tpl && Array.isArray(__lastTemplates) && __lastTemplates.length){
      tpl = toEditorTemplate(__lastTemplates[(payload?.i? (Number(payload.i)-1):0)] || __lastTemplates[0]);
    }

    // keep latest settings for editor intelligence
    try{
      localStorage.setItem("nexora_last_settings_v1", JSON.stringify({ category: cat, style, prompt: $("#prompt").value.trim(), notes: $("#notes").value.trim(), count: Number($("#count")?.value||24) }));
    } catch (e) {}

    // Also store selected template in a stable key
    try{
      if(tpl) localStorage.setItem("nexora_selected_template_v1", JSON.stringify(tpl));
    } catch (e) {}

    // Store draft so editor can load a REAL template (elements/positions)
    localStorage.setItem("templify_draft", JSON.stringify({
      meta: {
        cat,
        style,
        i: payload?.i || 1,
        prompt: $("#prompt").value.trim(),
        notes: $("#notes").value.trim(),
        title: (tpl?.title || payload?.title || null),
        description: (tpl?.description || payload?.description || payload?.subtitle || null),
      },
      template: tpl,
      createdAt: Date.now()
    }));

    // allow homepage to restore when user comes back from editor
    try{ sessionStorage.setItem("nexora_restore_home_v1","1"); } catch (e) {}
    try{ saveHomeState && saveHomeState(); } catch (e) {}
    window.location.href = location.origin + "/editor.html";
  }

  // Keep latest generated templates (for tile click -> editor)
  let __lastTemplates = [];

  // HARD GATE: homepage renders ONLY real templates (canvas + elements[]).
  // This prevents contract-only / mock / legacy objects from rendering as blank boxes.
  function isRenderableTemplate(t){
    const canvas = t && (t.canvas || t.contract?.canvas);
    const els = (Array.isArray(t?.elements) ? t.elements : null)
      || (Array.isArray(t?.contract?.elements) ? t.contract.elements : null)
      || (Array.isArray(t?.content?.elements) ? t.content.elements : null);
    return !!(canvas && Array.isArray(els) && els.length);
  }


  // --- Homepage state persistence (restore after returning from editor) ---
  const HOME_STATE_KEY = "nexora_home_state_v1";

  function getNavType(){
    try{
      const nav = performance.getEntriesByType && performance.getEntriesByType("navigation");
      if(nav && nav[0] && nav[0].type) return nav[0].type;
    } catch (e) {}
    try{
      if(performance && performance.navigation){
        const t = performance.navigation.type;
        if(t === 1) return "reload";
        if(t === 2) return "back_forward";
      }
    } catch (e) {}
    return "navigate";
  }

  function saveHomeState(){
    try{
      const catEl = document.getElementById("cat");
      const countEl = document.getElementById("count");
      const styleEl = document.getElementById("style");
      const promptEl = document.getElementById("prompt");
      const notesEl = document.getElementById("notes");
      const state = {
        v: 1,
        ts: Date.now(),
        scrollY: window.scrollY || 0,
        settings: {
          cat: catEl ? catEl.value : "",
          count: countEl ? (Number(countEl.value||1) || 1) : 1,
          style: styleEl ? styleEl.value : "",
          prompt: promptEl ? (promptEl.value||"") : "",
          notes: notesEl ? (notesEl.value||"") : ""
        },
        templates: Array.isArray(__lastTemplates) ? __lastTemplates : []
      };
      sessionStorage.setItem(HOME_STATE_KEY, JSON.stringify(state));
    } catch (e) {}
  }

  function loadHomeState(){
    try{
      const raw = sessionStorage.getItem(HOME_STATE_KEY);
      if(!raw) return null;
      const st = JSON.parse(raw);
      if(!st || !Array.isArray(st.templates) || !st.settings) return null;
      return st;
    } catch (e) { return null; }
  }

  function clearHomeState(){
    try{ sessionStorage.removeItem(HOME_STATE_KEY); } catch (e) {}
    try{ sessionStorage.removeItem("nexora_restore_home_v1"); } catch (e) {}
  }

  
function renderTemplatesFromList(list){
  const gridEl = document.getElementById("previewGrid");
  if(!gridEl) return;

  const arr = Array.isArray(list) ? list.filter(isRenderableTemplate) : [];
  if(arr.length === 0){
    // Keep placeholders, but do not render non-template objects.
    if(statusEl) statusEl.textContent = "No renderable templates to preview";
    return;
  }

  const TOC = window.TemplateOutputController || null;

  const nextTemplates = [];
  const frag = document.createDocumentFragment();

  arr.forEach((t, i)=>{
    const div = document.createElement("div");
    div.className = "tile";
    div.tabIndex = 0;

    const catLabel = (t?.contract?.category || document.getElementById("cat")?.value || "Template");
    div.innerHTML = `
      <div class="preview-canvas" aria-label="Template preview"></div>
      <b>${catLabel} #${i+1}</b>
      <span>AI output</span>
    `;

    // Attach template for deferred render.
    div.__tpl = t;

    nextTemplates.push(t);
    __lastTemplates = nextTemplates;

    div.addEventListener("click", ()=>openEditorWith(t));
    div.addEventListener("keydown",(e)=>{ if(e.key==="Enter") openEditorWith(t); });

    frag.appendChild(div);
  });

  // Update controller state for Export/OpenEditor determinism.
  if(TOC){
    if(typeof TOC.setTemplates === "function"){
      TOC.setTemplates(nextTemplates);
    }else{
      TOC.templates = nextTemplates;
    }
  }

  // Swap DOM in one shot.
  gridEl.innerHTML = "";
  gridEl.appendChild(frag);

  // Now that tiles are attached, render previews deterministically (API output only).
  requestAnimationFrame(()=>{
    try{
      const tiles = gridEl.querySelectorAll(".tile");
      tiles.forEach(tile=>{
        const t = tile.__tpl;
        const target = tile.querySelector(".preview-canvas");
        if(!target) return;

        // Normalize payload shape for preview-renderer.
        const hasContract = !!(t && t.contract);
        const contentObj = (t && (t.content || t.doc?.content)) || __synthContentFromElements(t) || {};
        // Ensure elements are available to the preview layer if we have them (top-level or contract-level).
        if(typeof contentObj === "object"){
          if(Array.isArray(t?.elements) && t.elements.length){
            if(!Array.isArray(contentObj.elements)) contentObj.elements = t.elements;
          }else if(Array.isArray(t?.contract?.elements) && t.contract.elements.length){
            if(!Array.isArray(contentObj.elements)) contentObj.elements = t.contract.elements;
          }
        }
        const payload = hasContract ? { contract: t.contract, content: contentObj } : {
          contract: t?.contract || t?.meta?.contract || {
            v: 1,
            category: t?.category || document.getElementById("cat")?.value || "instagram_post",
            canvas: t?.canvas || t?.contract?.canvas || { w: 1080, h: 1080 },
            // Include elements for preview validation when contract is synthetic.
            elements: (Array.isArray(contentObj?.elements) ? contentObj.elements : undefined)
          },
          content: contentObj
        };

        // Render real preview (no fake fallback).
        if(window.NexoraPreview && typeof window.NexoraPreview.renderTo === "function"){
          const __previewNormalized = (window.NexoraPreviewNormalization && typeof window.NexoraPreviewNormalization.normalize === "function")
            ? window.NexoraPreviewNormalization.normalize(payload)
            : payload;
          window.NexoraPreview.renderTo(target, __previewNormalized);
        }else if(TOC && typeof TOC.renderThumb === "function"){
          // Legacy path if preview renderer is missing
          TOC.renderThumb(t, target);
        }else{
          target.innerHTML = "";
        }

      });
    }catch(_){ }
  });

  // expose for debugging
  window.__lastTemplates = nextTemplates;
}

  // Expose for cross-script access
  window.renderTemplatesFromList = renderTemplatesFromList;


  function tryRestoreHome(){
    // only restore when we explicitly came back from editor; refresh should reset
    const navType = getNavType();
    if(navType === "reload"){ clearHomeState(); return false; }

    try{
      const flag = sessionStorage.getItem("nexora_restore_home_v1");
      if(!flag) return false;

      const st = loadHomeState();
      if(!st) { sessionStorage.removeItem("nexora_restore_home_v1"); return false; }

      const catEl = document.getElementById("cat");
      const countEl = document.getElementById("count");
      const styleEl = document.getElementById("style");
      const promptEl = document.getElementById("prompt");
      const notesEl = document.getElementById("notes");

      if(catEl && st.settings.cat) catEl.value = st.settings.cat;
      if(countEl && st.settings.count) countEl.value = String(st.settings.count);
      if(styleEl && st.settings.style) styleEl.value = st.settings.style;
      if(promptEl) promptEl.value = st.settings.prompt || "";
      if(notesEl) notesEl.value = st.settings.notes || "";

      // If restored templates include contract/doc/content, treat as AI-committed so seed can't overwrite.
      try{
        window.__NEXORA_AI_COMMITTED__ = Array.isArray(st.templates) && st.templates.some(t => t && (t.contract || t.doc || t.content));
      }catch(_){ window.__NEXORA_AI_COMMITTED__ = window.__NEXORA_AI_COMMITTED__ || false; }

      const restored = Array.isArray(st.templates) ? st.templates.filter(isRenderableTemplate) : [];
      if(!restored.length){ clearHomeState(); return false; }
      renderTemplatesFromList(restored);

      requestAnimationFrame(()=>{ try{ window.scrollTo(0, st.scrollY||0); }catch(_){} });

      sessionStorage.removeItem("nexora_restore_home_v1");
      return true;
    }catch(_){
      try{ sessionStorage.removeItem("nexora_restore_home_v1"); } catch (e) {}
      return false;
    }
  }
  // Expose for cross-script access
  window.tryRestoreHome = tryRestoreHome;


  function escapeHtml(s){
    return String(s||"")
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#39;");
  }


  $("#openEditor").addEventListener("click", (ev)=>{
    ev.preventDefault();
    // If user didn't click a preview tile, open the latest generated template #1 (fallback to seeded)
    const first = (Array.isArray(__lastTemplates) && __lastTemplates.length ? __lastTemplates[0] : null);
    if(first){
      openEditorWith(first);
    }else{
      // No generated template yet; open editor with settings only (no mock template).
      openEditorWith({ cat: $("#cat").value, style: $("#style").value, i: 1 });
    }
  });
  $("#themeBtn").addEventListener("click", toggleTheme);

  $("#exportBtn").addEventListener("click", ()=>{
    const templates = Array.isArray(__lastTemplates) ? __lastTemplates : [];
    const payload = { templates, count: templates.length, exportedAt: Date.now() };
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "nexora_templates.json";
    a.click();
    URL.revokeObjectURL(a.href);
  });

  // restore theme + initial previews
  const saved = localStorage.getItem("templify_theme");
  if(saved==="light"||saved==="dark") setTheme(saved);
  // initial previews are rendered on DOMContentLoaded so restore can win
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  // Globals used by some UI modules (avoid ReferenceError)
  let currentLayout = "";
  let currentStyle = "";
    const restored = (window.tryRestoreHome ? window.tryRestoreHome() : false);
    if(!restored){ (window.seedTemplates ? window.seedTemplates(12) : null); }

  const btn = document.getElementById("generateBtn");
  if (!btn) {
    alert("Generate button not found. UI mismatch.");
    return;
  }

  btn.addEventListener("click", async (event) => {
    // New generation cycle: allow placeholders before AI, then lock after AI commit
    window.__NEXORA_AI_COMMITTED__ = false;

    const payload = {
      category: document.getElementById("cat")?.value || "Instagram Post",
      style: document.getElementById("style")?.value || "Dark Premium",
      count: parseInt(document.getElementById("count")?.value || "10", 10),
      prompt: document.getElementById("prompt")?.value || "",
      notes: document.getElementById("notes")?.value || ""
    };

    // Keep template boxes visible immediately, but do NOT generate mock previews.
    try { if (window.seedTemplates) window.seedTemplates(payload.count); } catch (e) {}

    try{ saveHomeState(); } catch (e) {}
    if(statusEl) statusEl.textContent = "Generatingâ€¦";

    try{
      const res = await fetch("/api/generate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ...payload, mode: "templates" })
      });

      if(!res || !res.ok){
        if(statusEl) statusEl.textContent = "Generation failed (API error)";
        return;
      }

      const data = await res.json().catch(()=>null);
      if(!data || !Array.isArray(data.templates) || !data.templates.length){
        if(statusEl) statusEl.textContent = "No templates returned (API)";
        return;
      }

      window.__NEXORA_AI_COMMITTED__ = true;
      __lastTemplates = Array.isArray(data.templates) ? data.templates.filter(isRenderableTemplate) : [];
      window.__lastTemplates = __lastTemplates;
      if(!__lastTemplates.length){ if(statusEl) statusEl.textContent = "API returned no renderable templates"; return; }

      if (window.renderTemplatesFromList) window.renderTemplatesFromList(__lastTemplates);
      try{ saveHomeState(); } catch (e) {}

      if(statusEl) statusEl.textContent = `Generated ${__lastTemplates.length} (AI templates)`;
    }catch(e){
      if(statusEl) statusEl.textContent = "Generation failed (network)";
      // Keep placeholders, never blank.
      return;
    }
  });
});
</script>
<script>
  document.getElementById("btnTemplates")?.addEventListener("click", () => {
    alert("Templates Libraryâ€“ coming soon");
  });

  document.getElementById("btnAnimate")?.addEventListener("click", () => {
    alert("Animate â€“ coming soon");
  });
</script>

<script type="module">
// Nexora: New Layout + New Style (SAFE)
// UI unchanged. Only updates the preview tile text.

const layouts = ["Bold","Clean","Modern","Minimal","Vibrant"];
const styles  = ["Dark Premium","Light Minimal","Neon","Glassmorphism","Corporate"];

const gridEl = document.getElementById("previewGrid");
const statusEl2 = document.getElementById("status");

function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function setStatus(msg){ if(statusEl2) statusEl2.textContent = msg; }

function updateTilesText(){
  // No-op: homepage previews are rendered ONLY from API output.
}


document.getElementById("newLayoutBtn")?.addEventListener("click", () => {
  updateTilesText({ layout: pick(layouts) });
  setStatus("New layout applied");
});

document.getElementById("newStyleBtn")?.addEventListener("click", () => {
  const s = pick(styles);
  const sel = document.getElementById("style");
  if(sel){
    const opt = Array.from(sel.options).find(o => o.textContent.trim() === s);
    if(opt) sel.value = opt.textContent.trim();
  }
  updateTilesText({ style: s });
  setStatus("New style applied");
});

</script>


</body>
</html>
